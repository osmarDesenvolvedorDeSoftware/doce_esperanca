<!doctype html>
<html lang="pt-BR">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>{% block title %}Painel Administrativo{% endblock %}</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css">
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    {% block extra_css %}{% endblock %}
    <style>
      body {
        min-height: 100vh;
        background-color: #f7f7f7;
      }
      .quill-editor {
        background-color: #fff;
      }
      .rich-text-container {
        min-height: 200px;
      }
    </style>
  </head>
  <body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-4">
      <div class="container-fluid">
        <a class="navbar-brand" href="{{ url_for('admin.dashboard') }}">Painel Administrativo</a>
        <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarAdmin" aria-controls="navbarAdmin" aria-expanded="false" aria-label="Alternar navegação">
          <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse" id="navbarAdmin">
          <ul class="navbar-nav me-auto mb-2 mb-lg-0">
            <li class="nav-item"><a class="nav-link" href="{{ url_for('admin.textos_list') }}">Textos</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('admin.banners_list') }}">Banners</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('admin.parceiros_list') }}">Parceiros</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('admin.apoios_list') }}">Apoios</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('admin.voluntarios_list') }}">Voluntários</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('admin.galeria_list') }}">Galeria</a></li>
            <li class="nav-item"><a class="nav-link" href="{{ url_for('admin.transparencia_list') }}">Transparência</a></li>
          </ul>
          <div class="d-flex">
            <a class="btn btn-outline-light" href="{{ url_for('admin.logout') }}">Sair</a>
          </div>
        </div>
      </div>
    </nav>

    <main class="container mb-5">
      {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
          {% for category, message in messages %}
            <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
              {{ message }}
              <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Fechar"></button>
            </div>
          {% endfor %}
        {% endif %}
      {% endwith %}
      {% block content %}{% endblock %}
    </main>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('[data-rich-text]').forEach(function (wrapper) {
          const targetId = wrapper.getAttribute('data-target');
          const hiddenField = document.getElementById(targetId);
          if (!hiddenField) {
            return;
          }

          const quill = new Quill(wrapper, { theme: 'snow' });

          if (hiddenField.value) {
            quill.root.innerHTML = hiddenField.value;
          }

          const syncHiddenField = function () {
            hiddenField.value = quill.root.innerHTML;
            console.debug('[Quill Sync:' + targetId + ']', hiddenField.value);
          };

          syncHiddenField();

          quill.on('text-change', function () {
            syncHiddenField();
          });

          const form = wrapper.closest('form');
          if (form) {
            form.addEventListener('submit', function () {
              console.debug('[Quill Submit:' + targetId + ']', quill.root.innerHTML);
              hiddenField.value = quill.root.innerHTML;
            });
          }
        });
      });
    </script>
    <script>
      document.addEventListener("DOMContentLoaded", function () {
        // Remove required de textareas ocultos logo ao carregar
        document.querySelectorAll("textarea[required]").forEach(function (el) {
          const style = window.getComputedStyle(el);
          if (el.classList.contains("d-none") || style.display === "none" || style.visibility === "hidden") {
            el.removeAttribute("required");
          }
        });

        // Garante que o mesmo ocorra antes de qualquer envio
        document.addEventListener("submit", function (event) {
          const form = event.target;
          if (!(form instanceof HTMLFormElement)) return;

          form.querySelectorAll("textarea[required]").forEach(function (el) {
            const style = window.getComputedStyle(el);
            if (el.classList.contains("d-none") || style.display === "none" || style.visibility === "hidden") {
              el.removeAttribute("required");
            }
          });
        }, true);
      });
    </script>
    {% block extra_js %}{% endblock %}
  </body>
</html>
