{% extends "public/base.html" %}

{% block title %}Doação - Doce Esperança{% endblock %}

{% block content %}
  <div class="container py-5">
    <div class="row justify-content-center mb-5">
      <div class="col-lg-10">
        <div class="bg-light p-4 p-md-5 rounded-4 shadow-sm h-100">
          <div class="d-flex flex-column flex-md-row align-items-start gap-4">
            <div class="text-primary display-5">
              <i class="bi bi-heart-fill" aria-hidden="true"></i>
            </div>
            <div>
              <h1 class="h2 fw-bold mb-3">Doação</h1>
              <p class="lead mb-0">Sua contribuição ajuda a manter e expandir as ações da Associação Doce Esperança.</p>
            </div>
          </div>
        </div>
      </div>
    </div>

    <section class="mb-5">
      <h2 class="h4 text-center text-uppercase text-muted mb-4">Escolha como contribuir</h2>
      <div class="row row-cols-1 row-cols-md-2 g-4">
        <div class="col">
          <div class="card h-100 shadow-sm border-0">
            <div class="card-body d-flex flex-column text-center">
              <div class="text-primary display-6 mb-3">
                <i class="bi bi-credit-card" aria-hidden="true"></i>
              </div>
              <h3 class="h5 fw-bold">Cartão de Crédito</h3>
              <p class="flex-grow-1">Entre em contato para receber o link seguro do nosso parceiro financeiro e realizar sua contribuição.</p>
              <a class="btn btn-primary" href="{{ url_for('public.contato') }}">Solicitar link</a>
            </div>
          </div>
        </div>
        <div class="col">
          <div class="card h-100 shadow-sm border-0">
            <div class="card-body d-flex flex-column text-center">
              <div class="text-warning display-6 mb-3">
                <i class="bi bi-receipt" aria-hidden="true"></i>
              </div>
              <h3 class="h5 fw-bold">Boleto Bancário</h3>
              <p class="flex-grow-1">Prefere boleto? Avise nossa equipe e enviaremos os dados para pagamento na data que for melhor para você.</p>
              <a class="btn btn-outline-warning" href="{{ url_for('public.contato') }}">Falar com a equipe</a>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section class="mb-5" id="pix-qrcode">
      <div class="row justify-content-center">
        <div class="col-lg-8">
          <div class="card border-0 shadow-sm">
            <div class="row g-0 align-items-center">
              <div class="col-md-5 p-4 text-center">
                {% if pix_qrcode_path %}
                  <img
                    src="{{ static_url(pix_qrcode_path) }}"
                    alt="QR Code para doações via PIX"
                    class="img-fluid rounded pix-qrcode-img"
                  >
                  <p class="mt-3 mb-0 fw-semibold">Escaneie o QR Code para doar via PIX</p>
                {% else %}
                  <div class="alert alert-info mb-0" role="status">
                    Em breve disponibilizaremos o QR Code para doações via PIX.
                  </div>
                {% endif %}
              </div>
              <div class="col-md-7 p-4">
                <h3 class="h5 fw-bold mb-3">Contribua usando o PIX</h3>
                <p>Utilize o aplicativo do seu banco para ler o QR Code ou copie a chave PIX da Doce Esperança. Cada contribuição fortalece nossos projetos sociais.</p>
                <div class="mb-3">
                  <span class="d-block small text-muted">Chave PIX (CNPJ)</span>
                  <strong class="d-block fs-5">{{ pix_key }}</strong>
                </div>
                <div class="d-flex flex-column flex-sm-row align-items-stretch align-items-sm-center gap-2">
                  <button class="btn btn-outline-primary" type="button" data-copy-pix data-copy-value="{{ pix_key }}" data-original-label="Copiar chave PIX">
                    <i class="bi bi-clipboard-check me-2"></i>Copiar chave PIX
                  </button>
                  <button class="btn btn-outline-secondary" type="button" data-bs-toggle="collapse" data-bs-target="#pix-copy-code" aria-expanded="false" aria-controls="pix-copy-code">
                    <i class="bi bi-qr-code me-2"></i>Ver código copia e cola
                  </button>
                </div>
                <div id="pix-copy-code" class="collapse mt-3">
                  <p class="small text-muted mb-2">Código PIX copia e cola:</p>
                  <div class="bg-light border rounded p-3 text-break small">
                    {{ pix_copy_paste }}
                  </div>
                  <button class="btn btn-sm btn-outline-primary mt-2" type="button" data-copy-pix data-copy-value="{{ pix_copy_paste }}" data-original-label="Copiar código PIX completo">
                    Copiar código PIX completo
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <section>
      <div class="d-flex align-items-center gap-3 mb-3">
        <div class="text-secondary fs-3">
          <i class="bi bi-file-earmark-text" aria-hidden="true"></i>
        </div>
        <h3 class="h4 mb-0">Transparência</h3>
      </div>
      {% if documentos %}
        <div class="accordion" id="transparenciaAccordion">
          {% for documento in documentos %}
            <div class="accordion-item">
              <h4 class="accordion-header" id="transparenciaHeading{{ loop.index }}">
                <button
                  class="accordion-button{% if not loop.first %} collapsed{% endif %}"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#transparenciaCollapse{{ loop.index }}"
                  aria-expanded="{{ 'true' if loop.first else 'false' }}"
                  aria-controls="transparenciaCollapse{{ loop.index }}"
                >
                  {{ documento.titulo }}
                </button>
              </h4>
              <div
                id="transparenciaCollapse{{ loop.index }}"
                class="accordion-collapse collapse{% if loop.first %} show{% endif %}"
                aria-labelledby="transparenciaHeading{{ loop.index }}"
                data-bs-parent="#transparenciaAccordion"
              >
                <div class="accordion-body">
                  {% if documento.descricao %}
                    <p>{{ documento.descricao }}</p>
                  {% endif %}
                  <a
                    class="btn btn-link p-0"
                    href="{{ static_url(documento.arquivo_path) }}"
                    target="_blank"
                    rel="noopener"
                  >
                    Acessar documento
                  </a>
                </div>
              </div>
            </div>
          {% endfor %}
        </div>
      {% else %}
        <p class="texto-placeholder">
          {{ content_placeholder }}
        </p>
      {% endif %}
    </section>
  </div>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const copyButtons = document.querySelectorAll('[data-copy-pix]');

      function copyToClipboard(value) {
        if (navigator.clipboard && window.isSecureContext) {
          return navigator.clipboard.writeText(value);
        }

        return new Promise(function (resolve, reject) {
          const textArea = document.createElement('textarea');
          textArea.value = value;
          textArea.setAttribute('readonly', '');
          textArea.style.position = 'fixed';
          textArea.style.left = '-9999px';
          textArea.style.top = '-9999px';
          document.body.appendChild(textArea);

          const selection = document.getSelection();
          const selectedRange = selection && selection.rangeCount > 0 ? selection.getRangeAt(0) : null;

          textArea.select();
          textArea.setSelectionRange(0, value.length);

          let success = false;
          try {
            success = document.execCommand('copy');
          } catch (error) {
            success = false;
          }

          document.body.removeChild(textArea);

          if (selectedRange && selection) {
            selection.removeAllRanges();
            selection.addRange(selectedRange);
          }

          if (success) {
            resolve();
          } else {
            reject();
          }
        });
      }

      copyButtons.forEach(function (button) {
        const originalHTML = button.innerHTML;
        const originalLabel = button.getAttribute('data-original-label') || button.textContent.trim();
        button.addEventListener('click', function () {
          const value = button.getAttribute('data-copy-value');
          if (!value) {
            return;
          }

          copyToClipboard(value)
            .then(function () {
              button.classList.remove('btn-outline-primary');
              button.classList.add('btn-success');
              button.innerHTML = '<i class="bi bi-clipboard-check-fill me-2"></i>Copiado!';
              setTimeout(function () {
                button.classList.remove('btn-success');
                button.classList.add('btn-outline-primary');
                button.innerHTML = originalHTML || originalLabel;
              }, 2000);
            })
            .catch(function () {
              alert('Não foi possível copiar automaticamente. Copie manualmente: ' + value);
            });
        });
      });
    });
  </script>
{% endblock %}
